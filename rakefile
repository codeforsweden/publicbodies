require 'csv'
task :default => 'scrape:all'

namespace :scrape do
  
  desc "Scrape All"
  task :all do 

    puts "beginning scrape of all povincial and federal data"

    Dir["scrapers/*.rb"].each{|s|
    p "running #{s} ...."
    load s }

    puts "now compiling all data into ca.csv"

    ## append ca.csv with provincial data
    files = Dir["data/*.csv"] 

    CSV.open('ca.csv', 'w') do |csv|
      files.each do |file_name|
        CSV.foreach(file_name) do |row|
          next if row.include? 'title'
          csv << row
        end
      end
    end
  end

  desc "update a specific scrapers information and edit ca.csv accordingly"
  task :update, [:scrapers] do |t, args|
    
    if args[:scrapers]
      scrapers = args[:scrapers].split
      scrapers.each do |scraper|
        puts "Scraping #{scraper}"
        system("ruby scrapers/#{scraper}.rb")
      end
    end

    files = Dir["provincial_data/*.csv"]
    CSV.open('ca.csv', 'w') do |csv|
      files.each do |file_name|
        CSV.foreach(file_name) do |row|
          next if row.include? 'title'
          csv << row
        end
      end
    end
  end

end