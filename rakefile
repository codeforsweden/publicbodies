require 'csv'
task :default => 'scrape:all'

namespace :scrape do
  
  desc "Scrape All"
  task :all do 

    puts "beginning scrape of all povincial and federal data"

    Dir["scrapers/*.rb"].each{|s|
    p "running #{s} ...."
    load s }

    puts "now compiling all data into ca.csv"

    ## append ca.csv with provincial data
    files = Dir["data/*.csv"] 

    CSV.open('ca.csv', 'w') do |csv|
      files.each do |file_name|
        CSV.foreach(file_name) do |row|
          next if row.include? 'title'
          csv << row
        end
      end
    end
  end

  desc "update a specific scrapers information and edit ca.csv accordingly"
  task :update, [:scrapers] do |t, args|
    
    if args[:scrapers]
      scrapers = args[:scrapers].split
      scrapers.each do |scraper|
        puts "Scraping #{scraper}"
        system("ruby scrapers/#{scraper}.rb")
      end
    end

    files = Dir["data/*.csv"]
    CSV.open('ca.csv', 'w') do |csv|
      csv << %w(title abbr key category parent parent_key description url jurisdiction jurisdiction_code source source_url address contact email tags created_at updated_at)

      files.each do |file_name|
        p file_name
        csv_text = File.read(file_name)
        csv_content = CSV.parse(csv_text, :headers => true)
        csv_content.each do |row|
          csv << row
        end      
      end
    end
  end

end